<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fatura de Loca√ß√£o ‚Äì Gerador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f1f5f9; }
    .box { border:1.5px solid #1f2937; }
    .title { background:#e5e7eb; font-weight:600; padding:6px 10px; border-bottom:1.5px solid #1f2937; }
    .kv label{ font-size:11px; color:#374151; display:block; }
    .kv input, .kv textarea, .kv select{ width:100%; border:1px solid #cbd5e1; border-radius:6px; padding:6px 8px; }
    .kv .ro{ background:#f8fafc; }
    @media print {
      .no-print { display:none!important; }
      body { background:white; }
      .shadow-xl{ box-shadow:none; }
    }
    table.invoice th, table.invoice td{ border-left:1px solid #1f2937; border-right:1px solid #1f2937; }
    table.invoice thead tr{ border-top:1.5px solid #1f2937; border-bottom:1.5px solid #1f2937; }
    table.invoice tfoot tr{ border-top:1.5px solid #1f2937; }
    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.open{ display:flex; }
  </style>
</head>
<body class="text-slate-800">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="no-print flex flex-wrap items-center justify-between gap-3 mb-3">
      <h1 class="text-xl font-bold">üßæ Gerador de Faturas de Loca√ß√£o</h1>
      <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
        <!-- CLIENTES R√ÅPIDO -->
        <div class="flex items-center gap-2">
          <label for="clientSelect" class="text-sm">Cliente:</label>
          <select id="clientSelect" class="border rounded px-2 py-2 text-sm min-w-[240px]"></select>
          <button id="btnAddClient" class="px-3 py-2 rounded bg-indigo-600 text-white">+ Cliente</button>
          <button id="btnManageClients" class="px-3 py-2 rounded border">Gerenciar</button>
        </div>
        <!-- A√á√ïES -->
        <div class="flex gap-2">
          <button id="btnUseTemplate" class="px-3 py-2 rounded bg-violet-600 text-white">Usar modelo</button>
          <button id="btnSaveTemplate" class="px-3 py-2 rounded bg-slate-800 text-white">Salvar modelo</button>
          <button id="btnClear" class="px-3 py-2 rounded border">Limpar</button>
          <button id="btnPrint" class="px-3 py-2 rounded bg-emerald-600 text-white">Imprimir/PDF</button>
        </div>
      </div>
    </header>

    <div id="app" class="bg-white shadow-xl rounded-xl overflow-hidden box">
      <!-- CABE√áALHO -->
      <section class="grid grid-cols-12">
        <!-- Logo + empresa -->
        <div class="col-span-9 p-3 flex gap-3 items-start">
          <div class="flex flex-col items-center gap-1">
            <img id="logoPreview" class="w-16 h-16 object-contain" alt="Logo" />
            <div class="no-print text-[11px] text-slate-600">
              <input id="logoInput" type="file" accept="image/*" />
              <button id="btnClearLogo" class="underline">Remover</button>
            </div>
          </div>
          <div class="text-center w-full">
            <div class="text-[15px] font-bold">TRANSELIAN TRANSPORTES LTDA - ME</div>
            <div class="text-[12px] leading-tight">
              <div>RUA DA VILLARES, N¬∞ 248, B. SIDERURGIA ‚Äì OURO BRANCO ‚Äì MINAS GERAIS</div>
              <div>CEP: 36420-000 &nbsp; CNPJ: <span id="issuerDocView"></span> &nbsp; CONTATO: <span id="issuerContactView"></span></div>
            </div>
          </div>
        </div>
        <!-- Quadro Fatura -->
        <div class="col-span-3 p-3 box border-l-0">
          <div class="text-center text-[13px] font-semibold">FATURA<br>DE LOCA√á√ÉO</div>
          <div class="mt-6 text-center">
            <div class="text-[12px]">N¬∞</div>
            <div class="text-xl font-bold" id="invNumberView">000</div>
            <div class="mt-2 text-[12px]">DATA:</div>
            <div class="text-[13px] font-semibold" id="invDateView">__/__/____</div>
          </div>
        </div>
      </section>

      <!-- BLOCOS DESTINAT√ÅRIO / CONTRATO / PAGAMENTO / OBS -->
      <section class="grid grid-cols-12">
        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">DESTINAT√ÅRIO</div>
          <div class="p-3 grid grid-cols-12 gap-3 kv text-[12px]">
            <div class="col-span-6">
              <label>Raz√£o Social</label>
              <input id="clientName" placeholder="PRUMO ENGENHARIA EIRELI" />
            </div>
            <div class="col-span-3">
              <label>CNPJ / CPF</label>
              <input id="clientDoc" placeholder="20.651.311/0001-28" />
            </div>
            <div class="col-span-2">
              <label>CEP</label>
              <input id="clientCEP" placeholder="35570009" />
            </div>
            <div class="col-span-1">
              <label>UF</label>
              <input id="clientUF" placeholder="MG" />
            </div>
            <div class="col-span-8">
              <label>Endere√ßo</label>
              <input id="clientAddr" placeholder="P√ÅTIO DA ESTA√á√ÉO FERROVI√ÅRIA, 15 ‚Äì CENTRO" />
            </div>
            <div class="col-span-3">
              <label>Cidade</label>
              <input id="clientCity" placeholder="FORMIGA" />
            </div>
            <div class="col-span-1">
              <label>Inscr. Est.</label>
              <input id="clientIE" placeholder="" />
            </div>
          </div>
        </div>

        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">CONTRATO</div>
          <div class="p-3 grid grid-cols-12 gap-3 kv text-[12px]">
            <div class="col-span-3">
              <label>Contrato</label>
              <input id="contractNum" placeholder="3531/2022" />
            </div>
            <div class="col-span-3">
              <label>PC</label>
              <input id="pcNum" placeholder="447377" />
            </div>
            <div class="col-span-3">
              <label>Valor Mensal</label>
              <input id="monthlyValue" type="number" step="0.01" placeholder="18000,00" />
            </div>
            <div class="col-span-3">
              <label>Vencimento</label>
              <input id="dueDate" type="date" />
            </div>
          </div>
        </div>

        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">PAGAMENTO</div>
          <div class="p-3 grid grid-cols-12 gap-3 kv text-[12px]">
            <div class="col-span-3">
              <label>Forma</label>
              <input id="paymentTerms" placeholder="DEP√ìSITO BANC√ÅRIO" />
            </div>
            <div class="col-span-9">
              <label>Dados Banc√°rios</label>
              <textarea id="bankData" rows="3" placeholder="BANCO DO BRASIL
AG√äNCIA: 2372-8
CONTA CORRENTE: 20567-2
TRANSELIAN TRANSPORTES LTDA"></textarea>
            </div>
          </div>
        </div>

        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">OBSERVA√á√ÉO</div>
          <div class="p-3 kv text-[12px]">
            <textarea id="notes" rows="3" placeholder="DESCONTO COMPRA DE 4 PNEUS (EDIM) SEGUNDA PARCELA : R$ 4.200,00"></textarea>
          </div>
        </div>
      </section>

      <!-- ITENS / DADOS DA LOCA√á√ÉO -->
      <section class="">
        <div class="title">DADOS DA LOCA√á√ÉO</div>
        <div class="p-0">
          <div class="no-print p-3 flex items-center gap-2">
            <button id="btnAddItem" class="px-3 py-2 rounded border">Adicionar item</button>
          </div>
          <div class="overflow-x-auto">
            <table class="invoice w-full text-[12px] border-collapse">
              <thead class="bg-gray-100">
                <tr>
                  <th class="text-left p-2 w-24">C√≥digo</th>
                  <th class="text-left p-2">Descri√ß√£o / Quantidade</th>
                  <th class="text-right p-2 w-32">Valor Unit√°rio</th>
                  <th class="text-right p-2 w-32">Valor Total</th>
                  <th class="no-print w-24"></th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
              <tfoot>
                <tr>
                  <td class="p-2" colspan="2"></td>
                  <td class="p-2 text-right font-semibold">Valor Total da Fatura:</td>
                  <td class="p-2 text-right font-bold text-[14px]" id="totalView">R$ 0,00</td>
                  <td class="no-print"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- RECIBO -->
      <section class="grid grid-cols-12">
        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="p-3 text-[11px]">
            RECEBI(EMOS) DE <span class="font-semibold">EMPRESA</span>, AS LOCA√á√ïES CONSTANTES NESSA FATURA INDICADA AO LADO.
          </div>
        </div>
        <div class="col-span-6 box border-l-0 border-r-0">
          <div class="p-3 grid grid-cols-12 text-[12px] gap-2">
            <div class="col-span-6">DATA DO RECEBIMENTO</div>
            <div class="col-span-6">IDENTIFICA√á√ÉO E ASSINATURA DO RECEBEDOR</div>
          </div>
        </div>
        <div class="col-span-6 box border-l-0 border-r-0">
          <div class="p-3 text-right text-[13px]">N¬∞: <span id="invNumberView2">000</span></div>
        </div>
      </section>
    </div>

    <!-- Prefer√™ncias/backup -->
    <div class="no-print mt-4 text-sm flex flex-wrap gap-2">
      <button id="btnSaveCurrent" class="px-3 py-2 rounded border">Salvar rascunho</button>
      <button id="btnLoadCurrent" class="px-3 py-2 rounded border">Carregar rascunho</button>
      <button id="btnExportJson" class="px-3 py-2 rounded border">Exportar JSON</button>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button id="btnImportJson" class="px-3 py-2 rounded border">Importar JSON</button>
      <span class="mx-2"></span>
      <button id="btnExportClients" class="px-3 py-2 rounded border">Exportar clientes</button>
      <input id="importClientsFile" type="file" accept="application/json" class="hidden" />
      <button id="btnImportClients" class="px-3 py-2 rounded border">Importar clientes</button>
    </div>
  </div>

  <!-- MODAL CLIENTE -->
  <div id="clientModal" class="modal">
    <div class="bg-white w-[680px] max-w-[95vw] rounded-xl shadow-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Cliente</h3>
        <button id="closeClientModal" class="px-2 py-1 rounded border">Fechar</button>
      </div>
      <div class="grid grid-cols-12 gap-3 kv text-[12px]">
        <div class="col-span-8"><label>Raz√£o Social</label><input id="m_name" /></div>
        <div class="col-span-4"><label>CNPJ/CPF</label><input id="m_doc" /></div>
        <div class="col-span-8"><label>Endere√ßo</label><input id="m_addr" /></div>
        <div class="col-span-3"><label>Cidade</label><input id="m_city" /></div>
        <div class="col-span-1"><label>UF</label><input id="m_uf" /></div>
        <div class="col-span-3"><label>CEP</label><input id="m_cep" /></div>
        <div class="col-span-3"><label>Inscr. Estadual</label><input id="m_ie" /></div>
        <div class="col-span-12"><label>Contato (opcional)</label><input id="m_contact" /></div>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-sm text-slate-600">Os clientes ficam salvos no seu navegador (localStorage).</div>
        <div class="flex gap-2">
          <button id="btnDeleteClient" class="px-3 py-2 rounded border border-rose-300 text-rose-700">Excluir</button>
          <button id="btnSaveClient" class="px-3 py-2 rounded bg-indigo-600 text-white">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL GERENCIAR CLIENTES -->
  <div id="manageModal" class="modal">
    <div class="bg-white w-[720px] max-w-[95vw] rounded-xl shadow-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Gerenciar clientes</h3>
        <button id="closeManageModal" class="px-2 py-1 rounded border">Fechar</button>
      </div>
      <div class="max-h-[60vh] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50">
            <tr><th class="p-2 text-left">Raz√£o Social</th><th class="p-2 text-left">Documento</th><th class="p-2">A√ß√µes</th></tr>
          </thead>
          <tbody id="clientsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const el=(t,c)=>{const e=document.createElement(t); if(c) e.className=c; return e;};
    const fmt=(v)=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
    const store={set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),get:(k,d=null)=>{try{return JSON.parse(localStorage.getItem(k))??d;}catch{return d;}},del:(k)=>localStorage.removeItem(k)};

    const inputs={
      issuerDocView: $('#issuerDocView'), issuerContactView: $('#issuerContactView'),
      clientName: $('#clientName'), clientDoc: $('#clientDoc'), clientCEP: $('#clientCEP'), clientUF: $('#clientUF'), clientAddr: $('#clientAddr'), clientCity: $('#clientCity'), clientIE: $('#clientIE'),
      contractNum: $('#contractNum'), pcNum: $('#pcNum'), monthlyValue: $('#monthlyValue'), dueDate: $('#dueDate'),
      paymentTerms: $('#paymentTerms'), bankData: $('#bankData'), notes: $('#notes')
    };

    const DEFAULT={
      issuerDocView:'07.958.145/0001-49',
      issuerContactView:'(31) 9 96331518 - ALMIR',
      invNumber:'299', invDate:'2025-08-30',
      clientName:'PRUMO ENGENHARIA EIRELI', clientDoc:'20.651.311/0001-28', clientCEP:'35570009', clientUF:'MG', clientAddr:'P√ÅTIO DA ESTA√á√ÉO FERROVI√ÅRIA, 15 ‚Äì CENTRO', clientCity:'FORMIGA', clientIE:'2.612.401.260.076',
      contractNum:'3531/2022', pcNum:'447377', monthlyValue:18000, dueDate:'2025-10-07',
      paymentTerms:'DEP√ìSITO BANC√ÅRIO', bankData:'BANCO DO BRASIL
AG√äNCIA: 2372-8
CONTA CORRENTE: 20567-2
TRANSELIAN TRANSPORTES LTDA',
      notes:'DESCONTO COMPRA DE 4 PNEUS (EDIM) SEGUNDA PARCELA : R$ 4.200,00',
      items:[{code:'',desc:'LOCA√á√ÉO DE CAMINH√ÉO MUNCK, SEM MOTORISTA.
PLACA DO CAMINH√ÉO : RUB1A61
PER√çODO: 26/07/2025 a 25/08/2025
VENCIMENTO: 07/10/2025', qty:1, unit:13800.00}]
    };

    const state={logoDataUrl:'', items:[], clients:[], selectedClientId:null};
    const itemsBody=$('#itemsBody');
    const invNumberView=$('#invNumberView');
    const invNumberView2=$('#invNumberView2');
    const invDateView=$('#invDateView');
    const clientSelect=$('#clientSelect');

    // ===== Clientes =====
    function loadClients(){ state.clients = store.get('fatura_clients', []); renderClientSelect(); renderClientsTable(); }
    function saveClients(){ store.set('fatura_clients', state.clients); renderClientSelect(); renderClientsTable(); }

    function renderClientSelect(){
      clientSelect.innerHTML='';
      const opt0 = el('option'); opt0.value=""; opt0.textContent='‚Äî selecionar ‚Äî'; clientSelect.appendChild(opt0);
      state.clients.forEach(c=>{ const o=el('option'); o.value=c.id; o.textContent=c.name; clientSelect.appendChild(o); });
      if(state.selectedClientId){ clientSelect.value = state.selectedClientId; }
    }

    function renderClientsTable(){
      const tb = $('#clientsTable'); if(!tb) return; tb.innerHTML='';
      state.clients.forEach(c=>{
        const tr=el('tr');
        tr.innerHTML=`<td class="p-2">${c.name}</td><td class="p-2">${c.doc||''}</td>`;
        const td=el('td','p-2 text-right');
        const b1=el('button','px-2 py-1 rounded border mr-2'); b1.textContent='Editar'; b1.onclick=()=>openClientModal(c.id);
        const b2=el('button','px-2 py-1 rounded border'); b2.textContent='Usar'; b2.onclick=()=>{fillClient(c); closeManageModal();};
        td.append(b1,b2); tr.appendChild(td); tb.appendChild(tr);
      });
    }

    function fillClient(c){
      inputs.clientName.value=c.name||'';
      inputs.clientDoc.value=c.doc||'';
      inputs.clientCEP.value=c.cep||'';
      inputs.clientUF.value=c.uf||'';
      inputs.clientAddr.value=c.addr||'';
      inputs.clientCity.value=c.city||'';
      inputs.clientIE.value=c.ie||'';
      state.selectedClientId=c.id||null;
      clientSelect.value = state.selectedClientId||'';
      persistAll();
    }

    function openClientModal(id=null){
      const modal=$('#clientModal'); modal.classList.add('open');
      const c = id ? state.clients.find(x=>x.id===id) : {id:null};
      modal.dataset.id = c?.id || '';
      $('#m_name').value=c?.name||''; $('#m_doc').value=c?.doc||''; $('#m_addr').value=c?.addr||''; $('#m_city').value=c?.city||''; $('#m_uf').value=c?.uf||''; $('#m_cep').value=c?.cep||''; $('#m_ie').value=c?.ie||''; $('#m_contact').value=c?.contact||'';
    }
    function closeClientModal(){ $('#clientModal').classList.remove('open'); }

    function openManageModal(){ $('#manageModal').classList.add('open'); renderClientsTable(); }
    function closeManageModal(){ $('#manageModal').classList.remove('open'); }

    // Eventos clientes UI
    $('#btnAddClient').addEventListener('click',()=>openClientModal());
    $('#btnManageClients').addEventListener('click',()=>openManageModal());
    $('#closeClientModal').addEventListener('click',closeClientModal);
    $('#closeManageModal').addEventListener('click',closeManageModal);

    $('#btnSaveClient').addEventListener('click',()=>{
      const id = $('#clientModal').dataset.id || crypto.randomUUID();
      const c = {
        id,
        name: $('#m_name').value.trim(), doc: $('#m_doc').value.trim(), addr: $('#m_addr').value.trim(), city: $('#m_city').value.trim(), uf: $('#m_uf').value.trim(), cep: $('#m_cep').value.trim(), ie: $('#m_ie').value.trim(), contact: $('#m_contact').value.trim()
      };
      const idx = state.clients.findIndex(x=>x.id===id);
      if(idx>=0) state.clients[idx]=c; else state.clients.push(c);
      saveClients(); closeClientModal();
      // aplica imediatamente
      fillClient(c);
    });

    $('#btnDeleteClient').addEventListener('click',()=>{
      const id=$('#clientModal').dataset.id; if(!id) return; if(!confirm('Excluir este cliente?')) return;
      state.clients = state.clients.filter(x=>x.id!==id); saveClients(); closeClientModal(); renderClientsTable();
      if(state.selectedClientId===id){ state.selectedClientId=null; clientSelect.value=''; }
    });

    clientSelect.addEventListener('change',()=>{
      const id=clientSelect.value; const c=state.clients.find(x=>x.id===id); if(c) fillClient(c);
    });

    // Export/Import clientes
    $('#btnExportClients').addEventListener('click',()=>{
      const data=JSON.stringify(state.clients,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='clientes.json'; a.click(); URL.revokeObjectURL(url);
    });
    const importClientsFile=$('#importClientsFile');
    $('#btnImportClients').addEventListener('click',()=>importClientsFile.click());
    importClientsFile.addEventListener('change',(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ state.clients=JSON.parse(r.result)||[]; saveClients(); alert('Clientes importados.'); }catch{ alert('Arquivo inv√°lido.'); } }; r.readAsText(f); });

    // ===== Itens =====
    function addItemRow(item={code:'', desc:'', qty:1, unit:0}){
      const tr=el('tr');
      const tdCode=el('td','p-2 align-top');
      const tdDesc=el('td','p-2 align-top');
      const tdUnit=el('td','p-2 text-right align-top');
      const tdTot=el('td','p-2 text-right align-top');
      const tdDel=el('td','p-2 no-print');

      const iCode=el('input','w-full border rounded px-2 py-1 text-[12px]'); iCode.value=item.code||'';
      const iDesc=el('textarea','w-full border rounded px-2 py-1 text-[12px]'); iDesc.rows=3; iDesc.value=item.desc||'';
      const iUnit=el('input','w-full border rounded px-2 py-1 text-right text-[12px]'); iUnit.type='number'; iUnit.step='0.01'; iUnit.value=item.unit||0;
      const tot=el('div','text-[12px]');
      const btn=el('button','px-2 py-1 border rounded'); btn.textContent='Remover';

      tdCode.appendChild(iCode); tdDesc.appendChild(iDesc); tdUnit.appendChild(iUnit); tdTot.appendChild(tot); tdDel.appendChild(btn);
      tr.append(tdCode,tdDesc,tdUnit,tdTot,tdDel); itemsBody.appendChild(tr);

      function recalc(){ tot.textContent=fmt(parseFloat(iUnit.value||0)*(parseFloat(1))); persistAll(); updateTotals(); }
      [iCode,iDesc].forEach(x=>x.addEventListener('input',()=>{persistAll();}));
      iUnit.addEventListener('input',recalc);
      btn.addEventListener('click',()=>{ tr.remove(); persistAll(); updateTotals(); });
      recalc();
    }

    function persistAll(){
      const items=[...itemsBody.querySelectorAll('tr')].map(r=>{
        const [code,desc,unit]=r.querySelectorAll('input, textarea');
        return {code:code.value, desc:desc.value, qty:1, unit:parseFloat(unit.value)||0};
      });
      state.items=items;
      store.set('fatura_current', captureAll());
    }

    function updateTotals(){
      const total=state.items.reduce((a,it)=>a+(it.unit*(it.qty||1)),0);
      $('#totalView').textContent=fmt(total);
    }

    // Logo
    const logoInput=document.getElementById('logoInput');
    const btnClearLogo=document.getElementById('btnClearLogo');
    logoInput?.addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{state.logoDataUrl=r.result; document.getElementById('logoPreview').src=state.logoDataUrl; store.set('fatura_current', captureAll());}; r.readAsDataURL(f);});
    btnClearLogo?.addEventListener('click',()=>{state.logoDataUrl=''; document.getElementById('logoPreview').removeAttribute('src'); store.set('fatura_current', captureAll());});

    // Bot√µes topo
    document.getElementById('btnAddItem').addEventListener('click',()=>addItemRow());
    document.getElementById('btnPrint').addEventListener('click',()=>window.print());
    document.getElementById('btnClear').addEventListener('click',()=>{if(!confirm('Limpar tudo?')) return; store.del('fatura_current'); applyAll({items:[{desc:'',unit:0}]});});
    document.getElementById('btnUseTemplate').addEventListener('click',()=>{const t=store.get('fatura_template', DEFAULT); applyAll(t);});
    document.getElementById('btnSaveTemplate').addEventListener('click',()=>{store.set('fatura_template', captureAll()); alert('Modelo salvo!');});

    // Prefer√™ncias
    document.getElementById('btnSaveCurrent').addEventListener('click',()=>{store.set('fatura_current', captureAll()); alert('Rascunho salvo.');});
    document.getElementById('btnLoadCurrent').addEventListener('click',()=>{const s=store.get('fatura_current'); if(!s) return alert('Nenhum rascunho.'); applyAll(s);});
    document.getElementById('btnExportJson').addEventListener('click',()=>{const d=JSON.stringify(captureAll(),null,2); const blob=new Blob([d],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fatura.json'; a.click(); URL.revokeObjectURL(url);});
    const importFile=$('#importFile');
    document.getElementById('btnImportJson').addEventListener('click',()=>importFile.click());
    importFile.addEventListener('change',(e)=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{applyAll(JSON.parse(r.result));}catch{alert('JSON inv√°lido');}}; r.readAsText(f);});

    // Inputs para autosave
    ['input','change'].forEach(evt=>{
      document.addEventListener(evt,(e)=>{
        if(e.target && (e.target.matches('input')||e.target.matches('textarea')||e.target.matches('select'))) store.set('fatura_current', captureAll());
      });
    });

    function applyAll(d){
      const data={...DEFAULT, ...d};
      inputs.issuerDocView.textContent=data.issuerDocView||'';
      inputs.issuerContactView.textContent=data.issuerContactView||'';

      for(const k of ['clientName','clientDoc','clientCEP','clientUF','clientAddr','clientCity','clientIE','contractNum','pcNum','paymentTerms','bankData','notes']){
        if(inputs[k]) inputs[k].value = data[k]||'';
      }
      if(inputs.monthlyValue) inputs.monthlyValue.value = data.monthlyValue??0;
      if(inputs.dueDate) inputs.dueDate.value = data.dueDate||'';

      invNumberView.textContent = data.invNumber||'000';
      invNumberView2.textContent = data.invNumber||'000';
      invDateView.textContent = (data.invDate||'').split('-').reverse().join('/')||'';

      itemsBody.innerHTML='';
      state.items = data.items||[];
      state.items.forEach(addItemRow);
      updateTotals();
    }

    function captureAll(){
      return {
        issuerDocView: inputs.issuerDocView.textContent,
        issuerContactView: inputs.issuerContactView.textContent,
        clientName: inputs.clientName.value, clientDoc: inputs.clientDoc.value, clientCEP: inputs.clientCEP.value, clientUF: inputs.clientUF.value, clientAddr: inputs.clientAddr.value, clientCity: inputs.clientCity.value, clientIE: inputs.clientIE.value,
        contractNum: inputs.contractNum.value, pcNum: inputs.pcNum.value, monthlyValue: parseFloat(inputs.monthlyValue.value)||0, dueDate: inputs.dueDate.value,
        paymentTerms: inputs.paymentTerms.value, bankData: inputs.bankData.value, notes: inputs.notes.value,
        invNumber: invNumberView.textContent, invDate: invDateView.textContent.split('/').reverse().join('-'),
        items: state.items,
        selectedClientId: state.selectedClientId
      };
    }

    // Init
    (function(){
      loadClients();
      const saved=store.get('fatura_current');
      if(saved){ applyAll(saved); if(saved.selectedClientId){ const c=state.clients.find(x=>x.id===saved.selectedClientId); if(c) fillClient(c); } }
      else { applyAll(DEFAULT); }
    })();
  </script>
</body>
</html>
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fatura de Loca√ß√£o ‚Äì Gerador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f1f5f9; }
    .box { border:1.5px solid #1f2937; }
    .title { background:#e5e7eb; font-weight:600; padding:6px 10px; border-bottom:1.5px solid #1f2937; }
    .kv label{ font-size:11px; color:#374151; display:block; }
    .kv input, .kv textarea, .kv select{ width:100%; border:1px solid #cbd5e1; border-radius:6px; padding:6px 8px; }
    .kv .ro{ background:#f8fafc; }
    @media print {
      .no-print { display:none!important; }
      body { background:white; }
      .shadow-xl{ box-shadow:none; }
    }
    table.invoice th, table.invoice td{ border-left:1px solid #1f2937; border-right:1px solid #1f2937; }
    table.invoice thead tr{ border-top:1.5px solid #1f2937; border-bottom:1.5px solid #1f2937; }
    table.invoice tfoot tr{ border-top:1.5px solid #1f2937; }
    /* Modal */
    .modal{ position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.open{ display:flex; }
  </style>
</head>
<body class="text-slate-800">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="no-print flex flex-wrap items-center justify-between gap-3 mb-3">
      <h1 class="text-xl font-bold">üßæ Gerador de Faturas de Loca√ß√£o</h1>
      <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
        <!-- CLIENTES R√ÅPIDO -->
        <div class="flex items-center gap-2">
          <label for="clientSelect" class="text-sm">Cliente:</label>
          <select id="clientSelect" class="border rounded px-2 py-2 text-sm min-w-[240px]"></select>
          <button id="btnAddClient" class="px-3 py-2 rounded bg-indigo-600 text-white">+ Cliente</button>
          <button id="btnManageClients" class="px-3 py-2 rounded border">Gerenciar</button>
        </div>
        <!-- A√á√ïES -->
        <div class="flex gap-2">
          <button id="btnUseTemplate" class="px-3 py-2 rounded bg-violet-600 text-white">Usar modelo</button>
          <button id="btnSaveTemplate" class="px-3 py-2 rounded bg-slate-800 text-white">Salvar modelo</button>
          <button id="btnClear" class="px-3 py-2 rounded border">Limpar</button>
          <button id="btnPrint" class="px-3 py-2 rounded bg-emerald-600 text-white">Imprimir/PDF</button>
        </div>
      </div>
    </header>

    <div id="app" class="bg-white shadow-xl rounded-xl overflow-hidden box">
      <!-- CABE√áALHO -->
      <section class="grid grid-cols-12">
        <!-- Logo + empresa -->
        <div class="col-span-9 p-3 flex gap-3 items-start">
          <div class="flex flex-col items-center gap-1">
            <img id="logoPreview" class="w-16 h-16 object-contain" alt="Logo" />
            <div class="no-print text-[11px] text-slate-600">
              <input id="logoInput" type="file" accept="image/*" />
              <button id="btnClearLogo" class="underline">Remover</button>
            </div>
          </div>
          <div class="text-center w-full">
            <div class="text-[15px] font-bold">TRANSELIAN TRANSPORTES LTDA - ME</div>
            <div class="text-[12px] leading-tight">
              <div>RUA DA VILLARES, N¬∞ 248, B. SIDERURGIA ‚Äì OURO BRANCO ‚Äì MINAS GERAIS</div>
              <div>CEP: 36420-000 &nbsp; CNPJ: <span id="issuerDocView"></span> &nbsp; CONTATO: <span id="issuerContactView"></span></div>
            </div>
          </div>
        </div>
        <!-- Quadro Fatura -->
        <div class="col-span-3 p-3 box border-l-0">
          <div class="text-center text-[13px] font-semibold">FATURA<br>DE LOCA√á√ÉO</div>
          <div class="mt-6 text-center">
            <div class="text-[12px]">N¬∞</div>
            <div class="text-xl font-bold" id="invNumberView">000</div>
            <div class="mt-2 text-[12px]">DATA:</div>
            <div class="text-[13px] font-semibold" id="invDateView">__/__/____</div>
          </div>
        </div>
      </section>

      <!-- BLOCOS DESTINAT√ÅRIO / CONTRATO / PAGAMENTO / OBS -->
      <section class="grid grid-cols-12">
        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">DESTINAT√ÅRIO</div>
          <div class="p-3 grid grid-cols-12 gap-3 kv text-[12px]">
            <div class="col-span-6">
              <label>Raz√£o Social</label>
              <input id="clientName" placeholder="PRUMO ENGENHARIA EIRELI" />
            </div>
            <div class="col-span-3">
              <label>CNPJ / CPF</label>
              <input id="clientDoc" placeholder="20.651.311/0001-28" />
            </div>
            <div class="col-span-2">
              <label>CEP</label>
              <input id="clientCEP" placeholder="35570009" />
            </div>
            <div class="col-span-1">
              <label>UF</label>
              <input id="clientUF" placeholder="MG" />
            </div>
            <div class="col-span-8">
              <label>Endere√ßo</label>
              <input id="clientAddr" placeholder="P√ÅTIO DA ESTA√á√ÉO FERROVI√ÅRIA, 15 ‚Äì CENTRO" />
            </div>
            <div class="col-span-3">
              <label>Cidade</label>
              <input id="clientCity" placeholder="FORMIGA" />
            </div>
            <div class="col-span-1">
              <label>Inscr. Est.</label>
              <input id="clientIE" placeholder="" />
            </div>
          </div>
        </div>

        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">CONTRATO</div>
          <div class="p-3 grid grid-cols-12 gap-3 kv text-[12px]">
            <div class="col-span-3">
              <label>Contrato</label>
              <input id="contractNum" placeholder="3531/2022" />
            </div>
            <div class="col-span-3">
              <label>PC</label>
              <input id="pcNum" placeholder="447377" />
            </div>
            <div class="col-span-3">
              <label>Valor Mensal</label>
              <input id="monthlyValue" type="number" step="0.01" placeholder="18000,00" />
            </div>
            <div class="col-span-3">
              <label>Vencimento</label>
              <input id="dueDate" type="date" />
            </div>
          </div>
        </div>

        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">PAGAMENTO</div>
          <div class="p-3 grid grid-cols-12 gap-3 kv text-[12px]">
            <div class="col-span-3">
              <label>Forma</label>
              <input id="paymentTerms" placeholder="DEP√ìSITO BANC√ÅRIO" />
            </div>
            <div class="col-span-9">
              <label>Dados Banc√°rios</label>
              <textarea id="bankData" rows="3" placeholder="BANCO DO BRASIL
AG√äNCIA: 2372-8
CONTA CORRENTE: 20567-2
TRANSELIAN TRANSPORTES LTDA"></textarea>
            </div>
          </div>
        </div>

        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="title">OBSERVA√á√ÉO</div>
          <div class="p-3 kv text-[12px]">
            <textarea id="notes" rows="3" placeholder="DESCONTO COMPRA DE 4 PNEUS (EDIM) SEGUNDA PARCELA : R$ 4.200,00"></textarea>
          </div>
        </div>
      </section>

      <!-- ITENS / DADOS DA LOCA√á√ÉO -->
      <section class="">
        <div class="title">DADOS DA LOCA√á√ÉO</div>
        <div class="p-0">
          <div class="no-print p-3 flex items-center gap-2">
            <button id="btnAddItem" class="px-3 py-2 rounded border">Adicionar item</button>
          </div>
          <div class="overflow-x-auto">
            <table class="invoice w-full text-[12px] border-collapse">
              <thead class="bg-gray-100">
                <tr>
                  <th class="text-left p-2 w-24">C√≥digo</th>
                  <th class="text-left p-2">Descri√ß√£o / Quantidade</th>
                  <th class="text-right p-2 w-32">Valor Unit√°rio</th>
                  <th class="text-right p-2 w-32">Valor Total</th>
                  <th class="no-print w-24"></th>
                </tr>
              </thead>
              <tbody id="itemsBody"></tbody>
              <tfoot>
                <tr>
                  <td class="p-2" colspan="2"></td>
                  <td class="p-2 text-right font-semibold">Valor Total da Fatura:</td>
                  <td class="p-2 text-right font-bold text-[14px]" id="totalView">R$ 0,00</td>
                  <td class="no-print"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- RECIBO -->
      <section class="grid grid-cols-12">
        <div class="col-span-12 box border-l-0 border-r-0">
          <div class="p-3 text-[11px]">
            RECEBI(EMOS) DE <span class="font-semibold">EMPRESA</span>, AS LOCA√á√ïES CONSTANTES NESSA FATURA INDICADA AO LADO.
          </div>
        </div>
        <div class="col-span-6 box border-l-0 border-r-0">
          <div class="p-3 grid grid-cols-12 text-[12px] gap-2">
            <div class="col-span-6">DATA DO RECEBIMENTO</div>
            <div class="col-span-6">IDENTIFICA√á√ÉO E ASSINATURA DO RECEBEDOR</div>
          </div>
        </div>
        <div class="col-span-6 box border-l-0 border-r-0">
          <div class="p-3 text-right text-[13px]">N¬∞: <span id="invNumberView2">000</span></div>
        </div>
      </section>
    </div>

    <!-- Prefer√™ncias/backup -->
    <div class="no-print mt-4 text-sm flex flex-wrap gap-2">
      <button id="btnSaveCurrent" class="px-3 py-2 rounded border">Salvar rascunho</button>
      <button id="btnLoadCurrent" class="px-3 py-2 rounded border">Carregar rascunho</button>
      <button id="btnExportJson" class="px-3 py-2 rounded border">Exportar JSON</button>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button id="btnImportJson" class="px-3 py-2 rounded border">Importar JSON</button>
      <span class="mx-2"></span>
      <button id="btnExportClients" class="px-3 py-2 rounded border">Exportar clientes</button>
      <input id="importClientsFile" type="file" accept="application/json" class="hidden" />
      <button id="btnImportClients" class="px-3 py-2 rounded border">Importar clientes</button>
    </div>
  </div>

  <!-- MODAL CLIENTE -->
  <div id="clientModal" class="modal">
    <div class="bg-white w-[680px] max-w-[95vw] rounded-xl shadow-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Cliente</h3>
        <button id="closeClientModal" class="px-2 py-1 rounded border">Fechar</button>
      </div>
      <div class="grid grid-cols-12 gap-3 kv text-[12px]">
        <div class="col-span-8"><label>Raz√£o Social</label><input id="m_name" /></div>
        <div class="col-span-4"><label>CNPJ/CPF</label><input id="m_doc" /></div>
        <div class="col-span-8"><label>Endere√ßo</label><input id="m_addr" /></div>
        <div class="col-span-3"><label>Cidade</label><input id="m_city" /></div>
        <div class="col-span-1"><label>UF</label><input id="m_uf" /></div>
        <div class="col-span-3"><label>CEP</label><input id="m_cep" /></div>
        <div class="col-span-3"><label>Inscr. Estadual</label><input id="m_ie" /></div>
        <div class="col-span-12"><label>Contato (opcional)</label><input id="m_contact" /></div>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-sm text-slate-600">Os clientes ficam salvos no seu navegador (localStorage).</div>
        <div class="flex gap-2">
          <button id="btnDeleteClient" class="px-3 py-2 rounded border border-rose-300 text-rose-700">Excluir</button>
          <button id="btnSaveClient" class="px-3 py-2 rounded bg-indigo-600 text-white">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL GERENCIAR CLIENTES -->
  <div id="manageModal" class="modal">
    <div class="bg-white w-[720px] max-w-[95vw] rounded-xl shadow-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Gerenciar clientes</h3>
        <button id="closeManageModal" class="px-2 py-1 rounded border">Fechar</button>
      </div>
      <div class="max-h-[60vh] overflow-y-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50">
            <tr><th class="p-2 text-left">Raz√£o Social</th><th class="p-2 text-left">Documento</th><th class="p-2">A√ß√µes</th></tr>
          </thead>
          <tbody id="clientsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const el=(t,c)=>{const e=document.createElement(t); if(c) e.className=c; return e;};
    const fmt=(v)=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
    const store={set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),get:(k,d=null)=>{try{return JSON.parse(localStorage.getItem(k))??d;}catch{return d;}},del:(k)=>localStorage.removeItem(k)};

    const inputs={
      issuerDocView: $('#issuerDocView'), issuerContactView: $('#issuerContactView'),
      clientName: $('#clientName'), clientDoc: $('#clientDoc'), clientCEP: $('#clientCEP'), clientUF: $('#clientUF'), clientAddr: $('#clientAddr'), clientCity: $('#clientCity'), clientIE: $('#clientIE'),
      contractNum: $('#contractNum'), pcNum: $('#pcNum'), monthlyValue: $('#monthlyValue'), dueDate: $('#dueDate'),
      paymentTerms: $('#paymentTerms'), bankData: $('#bankData'), notes: $('#notes')
    };

    const DEFAULT={
      issuerDocView:'07.958.145/0001-49',
      issuerContactView:'(31) 9 96331518 - ALMIR',
      invNumber:'299', invDate:'2025-08-30',
      clientName:'PRUMO ENGENHARIA EIRELI', clientDoc:'20.651.311/0001-28', clientCEP:'35570009', clientUF:'MG', clientAddr:'P√ÅTIO DA ESTA√á√ÉO FERROVI√ÅRIA, 15 ‚Äì CENTRO', clientCity:'FORMIGA', clientIE:'2.612.401.260.076',
      contractNum:'3531/2022', pcNum:'447377', monthlyValue:18000, dueDate:'2025-10-07',
      paymentTerms:'DEP√ìSITO BANC√ÅRIO', bankData:'BANCO DO BRASIL
AG√äNCIA: 2372-8
CONTA CORRENTE: 20567-2
TRANSELIAN TRANSPORTES LTDA',
      notes:'DESCONTO COMPRA DE 4 PNEUS (EDIM) SEGUNDA PARCELA : R$ 4.200,00',
      items:[{code:'',desc:'LOCA√á√ÉO DE CAMINH√ÉO MUNCK, SEM MOTORISTA.
PLACA DO CAMINH√ÉO : RUB1A61
PER√çODO: 26/07/2025 a 25/08/2025
VENCIMENTO: 07/10/2025', qty:1, unit:13800.00}]
    };

    const state={logoDataUrl:'', items:[], clients:[], selectedClientId:null};
    const itemsBody=$('#itemsBody');
    const invNumberView=$('#invNumberView');
    const invNumberView2=$('#invNumberView2');
    const invDateView=$('#invDateView');
    const clientSelect=$('#clientSelect');

    // ===== Clientes =====
    function loadClients(){ state.clients = store.get('fatura_clients', []); renderClientSelect(); renderClientsTable(); }
    function saveClients(){ store.set('fatura_clients', state.clients); renderClientSelect(); renderClientsTable(); }

    function renderClientSelect(){
      clientSelect.innerHTML='';
      const opt0 = el('option'); opt0.value=""; opt0.textContent='‚Äî selecionar ‚Äî'; clientSelect.appendChild(opt0);
      state.clients.forEach(c=>{ const o=el('option'); o.value=c.id; o.textContent=c.name; clientSelect.appendChild(o); });
      if(state.selectedClientId){ clientSelect.value = state.selectedClientId; }
    }

    function renderClientsTable(){
      const tb = $('#clientsTable'); if(!tb) return; tb.innerHTML='';
      state.clients.forEach(c=>{
        const tr=el('tr');
        tr.innerHTML=`<td class="p-2">${c.name}</td><td class="p-2">${c.doc||''}</td>`;
        const td=el('td','p-2 text-right');
        const b1=el('button','px-2 py-1 rounded border mr-2'); b1.textContent='Editar'; b1.onclick=()=>openClientModal(c.id);
        const b2=el('button','px-2 py-1 rounded border'); b2.textContent='Usar'; b2.onclick=()=>{fillClient(c); closeManageModal();};
        td.append(b1,b2); tr.appendChild(td); tb.appendChild(tr);
      });
    }

    function fillClient(c){
      inputs.clientName.value=c.name||'';
      inputs.clientDoc.value=c.doc||'';
      inputs.clientCEP.value=c.cep||'';
      inputs.clientUF.value=c.uf||'';
      inputs.clientAddr.value=c.addr||'';
      inputs.clientCity.value=c.city||'';
      inputs.clientIE.value=c.ie||'';
      state.selectedClientId=c.id||null;
      clientSelect.value = state.selectedClientId||'';
      persistAll();
    }

    function openClientModal(id=null){
      const modal=$('#clientModal'); modal.classList.add('open');
      const c = id ? state.clients.find(x=>x.id===id) : {id:null};
      modal.dataset.id = c?.id || '';
      $('#m_name').value=c?.name||''; $('#m_doc').value=c?.doc||''; $('#m_addr').value=c?.addr||''; $('#m_city').value=c?.city||''; $('#m_uf').value=c?.uf||''; $('#m_cep').value=c?.cep||''; $('#m_ie').value=c?.ie||''; $('#m_contact').value=c?.contact||'';
    }
    function closeClientModal(){ $('#clientModal').classList.remove('open'); }

    function openManageModal(){ $('#manageModal').classList.add('open'); renderClientsTable(); }
    function closeManageModal(){ $('#manageModal').classList.remove('open'); }

    // Eventos clientes UI
    $('#btnAddClient').addEventListener('click',()=>openClientModal());
    $('#btnManageClients').addEventListener('click',()=>openManageModal());
    $('#closeClientModal').addEventListener('click',closeClientModal);
    $('#closeManageModal').addEventListener('click',closeManageModal);

    $('#btnSaveClient').addEventListener('click',()=>{
      const id = $('#clientModal').dataset.id || crypto.randomUUID();
      const c = {
        id,
        name: $('#m_name').value.trim(), doc: $('#m_doc').value.trim(), addr: $('#m_addr').value.trim(), city: $('#m_city').value.trim(), uf: $('#m_uf').value.trim(), cep: $('#m_cep').value.trim(), ie: $('#m_ie').value.trim(), contact: $('#m_contact').value.trim()
      };
      const idx = state.clients.findIndex(x=>x.id===id);
      if(idx>=0) state.clients[idx]=c; else state.clients.push(c);
      saveClients(); closeClientModal();
      // aplica imediatamente
      fillClient(c);
    });

    $('#btnDeleteClient').addEventListener('click',()=>{
      const id=$('#clientModal').dataset.id; if(!id) return; if(!confirm('Excluir este cliente?')) return;
      state.clients = state.clients.filter(x=>x.id!==id); saveClients(); closeClientModal(); renderClientsTable();
      if(state.selectedClientId===id){ state.selectedClientId=null; clientSelect.value=''; }
    });

    clientSelect.addEventListener('change',()=>{
      const id=clientSelect.value; const c=state.clients.find(x=>x.id===id); if(c) fillClient(c);
    });

    // Export/Import clientes
    $('#btnExportClients').addEventListener('click',()=>{
      const data=JSON.stringify(state.clients,null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='clientes.json'; a.click(); URL.revokeObjectURL(url);
    });
    const importClientsFile=$('#importClientsFile');
    $('#btnImportClients').addEventListener('click',()=>importClientsFile.click());
    importClientsFile.addEventListener('change',(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ state.clients=JSON.parse(r.result)||[]; saveClients(); alert('Clientes importados.'); }catch{ alert('Arquivo inv√°lido.'); } }; r.readAsText(f); });

    // ===== Itens =====
    function addItemRow(item={code:'', desc:'', qty:1, unit:0}){
      const tr=el('tr');
      const tdCode=el('td','p-2 align-top');
      const tdDesc=el('td','p-2 align-top');
      const tdUnit=el('td','p-2 text-right align-top');
      const tdTot=el('td','p-2 text-right align-top');
      const tdDel=el('td','p-2 no-print');

      const iCode=el('input','w-full border rounded px-2 py-1 text-[12px]'); iCode.value=item.code||'';
      const iDesc=el('textarea','w-full border rounded px-2 py-1 text-[12px]'); iDesc.rows=3; iDesc.value=item.desc||'';
      const iUnit=el('input','w-full border rounded px-2 py-1 text-right text-[12px]'); iUnit.type='number'; iUnit.step='0.01'; iUnit.value=item.unit||0;
      const tot=el('div','text-[12px]');
      const btn=el('button','px-2 py-1 border rounded'); btn.textContent='Remover';

      tdCode.appendChild(iCode); tdDesc.appendChild(iDesc); tdUnit.appendChild(iUnit); tdTot.appendChild(tot); tdDel.appendChild(btn);
      tr.append(tdCode,tdDesc,tdUnit,tdTot,tdDel); itemsBody.appendChild(tr);

      function recalc(){ tot.textContent=fmt(parseFloat(iUnit.value||0)*(parseFloat(1))); persistAll(); updateTotals(); }
      [iCode,iDesc].forEach(x=>x.addEventListener('input',()=>{persistAll();}));
      iUnit.addEventListener('input',recalc);
      btn.addEventListener('click',()=>{ tr.remove(); persistAll(); updateTotals(); });
      recalc();
    }

    function persistAll(){
      const items=[...itemsBody.querySelectorAll('tr')].map(r=>{
        const [code,desc,unit]=r.querySelectorAll('input, textarea');
        return {code:code.value, desc:desc.value, qty:1, unit:parseFloat(unit.value)||0};
      });
      state.items=items;
      store.set('fatura_current', captureAll());
    }

    function updateTotals(){
      const total=state.items.reduce((a,it)=>a+(it.unit*(it.qty||1)),0);
      $('#totalView').textContent=fmt(total);
    }

    // Logo
    const logoInput=document.getElementById('logoInput');
    const btnClearLogo=document.getElementById('btnClearLogo');
    logoInput?.addEventListener('change',e=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{state.logoDataUrl=r.result; document.getElementById('logoPreview').src=state.logoDataUrl; store.set('fatura_current', captureAll());}; r.readAsDataURL(f);});
    btnClearLogo?.addEventListener('click',()=>{state.logoDataUrl=''; document.getElementById('logoPreview').removeAttribute('src'); store.set('fatura_current', captureAll());});

    // Bot√µes topo
    document.getElementById('btnAddItem').addEventListener('click',()=>addItemRow());
    document.getElementById('btnPrint').addEventListener('click',()=>window.print());
    document.getElementById('btnClear').addEventListener('click',()=>{if(!confirm('Limpar tudo?')) return; store.del('fatura_current'); applyAll({items:[{desc:'',unit:0}]});});
    document.getElementById('btnUseTemplate').addEventListener('click',()=>{const t=store.get('fatura_template', DEFAULT); applyAll(t);});
    document.getElementById('btnSaveTemplate').addEventListener('click',()=>{store.set('fatura_template', captureAll()); alert('Modelo salvo!');});

    // Prefer√™ncias
    document.getElementById('btnSaveCurrent').addEventListener('click',()=>{store.set('fatura_current', captureAll()); alert('Rascunho salvo.');});
    document.getElementById('btnLoadCurrent').addEventListener('click',()=>{const s=store.get('fatura_current'); if(!s) return alert('Nenhum rascunho.'); applyAll(s);});
    document.getElementById('btnExportJson').addEventListener('click',()=>{const d=JSON.stringify(captureAll(),null,2); const blob=new Blob([d],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='fatura.json'; a.click(); URL.revokeObjectURL(url);});
    const importFile=$('#importFile');
    document.getElementById('btnImportJson').addEventListener('click',()=>importFile.click());
    importFile.addEventListener('change',(e)=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{applyAll(JSON.parse(r.result));}catch{alert('JSON inv√°lido');}}; r.readAsText(f);});

    // Inputs para autosave
    ['input','change'].forEach(evt=>{
      document.addEventListener(evt,(e)=>{
        if(e.target && (e.target.matches('input')||e.target.matches('textarea')||e.target.matches('select'))) store.set('fatura_current', captureAll());
      });
    });

    function applyAll(d){
      const data={...DEFAULT, ...d};
      inputs.issuerDocView.textContent=data.issuerDocView||'';
      inputs.issuerContactView.textContent=data.issuerContactView||'';

      for(const k of ['clientName','clientDoc','clientCEP','clientUF','clientAddr','clientCity','clientIE','contractNum','pcNum','paymentTerms','bankData','notes']){
        if(inputs[k]) inputs[k].value = data[k]||'';
      }
      if(inputs.monthlyValue) inputs.monthlyValue.value = data.monthlyValue??0;
      if(inputs.dueDate) inputs.dueDate.value = data.dueDate||'';

      invNumberView.textContent = data.invNumber||'000';
      invNumberView2.textContent = data.invNumber||'000';
      invDateView.textContent = (data.invDate||'').split('-').reverse().join('/')||'';

      itemsBody.innerHTML='';
      state.items = data.items||[];
      state.items.forEach(addItemRow);
      updateTotals();
    }

    function captureAll(){
      return {
        issuerDocView: inputs.issuerDocView.textContent,
        issuerContactView: inputs.issuerContactView.textContent,
        clientName: inputs.clientName.value, clientDoc: inputs.clientDoc.value, clientCEP: inputs.clientCEP.value, clientUF: inputs.clientUF.value, clientAddr: inputs.clientAddr.value, clientCity: inputs.clientCity.value, clientIE: inputs.clientIE.value,
        contractNum: inputs.contractNum.value, pcNum: inputs.pcNum.value, monthlyValue: parseFloat(inputs.monthlyValue.value)||0, dueDate: inputs.dueDate.value,
        paymentTerms: inputs.paymentTerms.value, bankData: inputs.bankData.value, notes: inputs.notes.value,
        invNumber: invNumberView.textContent, invDate: invDateView.textContent.split('/').reverse().join('-'),
        items: state.items,
        selectedClientId: state.selectedClientId
      };
    }

    // Init
    (function(){
      loadClients();
      const saved=store.get('fatura_current');
      if(saved){ applyAll(saved); if(saved.selectedClientId){ const c=state.clients.find(x=>x.id===saved.selectedClientId); if(c) fillClient(c); } }
      else { applyAll(DEFAULT); }
    })();
  </script>
</body>
</html>
